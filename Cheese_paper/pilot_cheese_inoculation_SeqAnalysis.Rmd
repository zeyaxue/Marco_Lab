---
title: "pilot_cheese_inoculation_sequencing"
author: "Zeya Zhengyao Xue"
date: "2/6/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This is the file to analysis pilot cheese project, including 
1. pilot cheeses
2. milk and cheeese where the isolates are from

## Setting up packages and working directory 
```{r}
library(phyloseq);packageVersion("phyloseq")
library(tidyr)
library(ggplot2)
library(reshape2)
library(plyr)
library(dplyr)
library(PMCMR)
library(vegan)
library(RColorBrewer)
library(superheat)
library(DESeq2);packageVersion("DESeq2")

path <- "G:/My Drive/UC_Davis/Marco_lab/milk_microbiota/2017_Hilmar_sampling/Sequencing/QIIME2/"
```


## Import QIIME2 output and make phyloseq object
```{r}
# Transpose the QIIME2 output in excel
SeqTab <- read.table(file.path(path,"Jan/feature-table-mc2.txt"), header = TRUE, stringsAsFactors = FALSE)
colnames(SeqTab) <- gsub("X","",colnames(SeqTab))
row.names(SeqTab) <- SeqTab$OTUID
SeqTab <- SeqTab[,-1]
SeqTab <- as.matrix.data.frame(SeqTab)

# Parse out taxonomic assignment in excel and remove confidence column
TaxTab <- read.table(file.path(path,"Jan/taxonomy-mc2.tsv"), header = TRUE, sep = '\t', na.strings = NA)
tax_col <- c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")
TaxTab <- separate(data = TaxTab, col = "Taxon", into = tax_col, sep = "; ", remove = TRUE, fill = "right")
# format taxon columns to remove preceding taxon letter (" p__, o__"")
TaxTab$Kingdom <- substring(TaxTab$Kingdom, 4)  # 4th letter start to keep
TaxTab$Phylum <- substring(TaxTab$Phylum, 4)
TaxTab$Class <- substring(TaxTab$Class, 4)
TaxTab$Order <- substring(TaxTab$Order, 4)
TaxTab$Family <- substring(TaxTab$Family, 4)
TaxTab$Genus <- substring(TaxTab$Genus, 4)
TaxTab$Species <- substring(TaxTab$Species, 4)
# organized as a matrix for phyloseq import
rownames(TaxTab) <- TaxTab$Feature.ID
TaxTab <- TaxTab[,-1]
TaxTab <- as.matrix.data.frame(TaxTab)

# Read in metadata file
# In the samdf file, L.fermentum R2 was removed due to potential contamination from 
samdf <- read.csv(file.path(path,"Jan/samdf_Jan_2019.csv"))
rownames(samdf) <- samdf$SampleID

# Read in exported rooted tree 
tree <- read_tree(file.path(path, "Jan/tree.nwk"))

### Merge as one phyloseq object
ps <- phyloseq(otu_table(SeqTab,taxa_are_rows = TRUE), tax_table(TaxTab), sample_data(samdf), phy_tree(tree))
ps # 282 taxa and 29 samples
```

## Filter ASVs based on taxonomy and abundance 
```{r}
# Show available ranks in the dataset
rank_names(ps)
# Create table, number of features for each phylum
table(tax_table(ps)[, "Phylum"], exclude = NULL)
# remove asv that was not assigned at phylum level
ps.Phy <- subset_taxa(ps, !is.na(Phylum) & !Phylum %in% c(""))
ps.Phy #  279 taxa and 29 samples 
# Explore abundance to decide filter threshold
## Compute prevalence of each feature, store as data.frame
prevdf <- apply(X = otu_table(ps.Phy),
                MARGIN = ifelse(taxa_are_rows(ps.Phy), yes = 1, no = 2),
                FUN = function(x)(sum(x>0)))
# Add taxonomy and total read counts to this data.frame
prevdf <- data.frame(Prevalence = prevdf,
                     TotalAbundance = taxa_sums(ps.Phy),
                     tax_table(ps.Phy))
# plot the abudance per phylum 
ggplot(prevdf, aes(TotalAbundance, Prevalence / nsamples(ps.Phy),color=Phylum)) +
  # Include a guess for parameter
  geom_hline(yintercept = 0.01,  linetype = 2) + geom_point(size = 2, alpha = 0.7) +
  scale_x_log10() +  xlab("Total Abundance") + ylab("Prevalence [Frac. Samples]") +
  facet_wrap(~Phylum) + theme(legend.position="none")

# Remove very low abudance ASVs independent of sample prevalence
x = taxa_sums(ps.Phy)
keepTaxa = which((x / sum(x)) > 0.00005)
ps.Phy05 <- prune_taxa(names(keepTaxa), ps.Phy)
ps.Phy05 # 175 taxa and 29 samples
```

## Determine rarefaction level for Alpha and Beta analysis later on
```{r}
set.seed(123)
# Define function to calculate alpha diversity and rarefaction levels
calculate_rarefaction_curves <- function(psdata, measures, depths) {
  estimate_rarified_richness <- function(psdata, measures, depth) {
    if(max(sample_sums(psdata)) < depth) return()
    psdata <- prune_samples(sample_sums(psdata) >= depth, psdata)
    rarified_psdata <- rarefy_even_depth(psdata, depth, verbose = FALSE)
    alpha_diversity <- estimate_richness(rarified_psdata, measures = measures)
    # as.matrix forces the use of melt.array, which includes the Sample names (rownames)
    molten_alpha_diversity <- melt(as.matrix(alpha_diversity), varnames = c("SampleID", 'measures'), value.name = 'Alpha_diversity')
    molten_alpha_diversity
  }
  names(depths) <- depths # this enables automatic addition of the Depth to the output by ldply
  rarefaction_curve_data <- ldply(depths, estimate_rarified_richness, psdata = psdata, measures = measures, .id = 'Depth', .progress = ifelse(interactive(), 'text', 'none'))
  #convert Depth from factor to numeric
  rarefaction_curve_data$Depth <- as.numeric(levels(rarefaction_curve_data$Depth))[rarefaction_curve_data$Depth]
  rarefaction_curve_data
}
rarefaction_curve_data <- calculate_rarefaction_curves(ps.Phy, c("Observed", "Shannon","Simpson","Chao1"), 
                                                       rep(c(1, 1000, 2500, 4000, 6000, 10000, 20000), each = 10))
rarefaction_curve_data$SampleID <- gsub("X","",rarefaction_curve_data$SampleID)
# summarize alpha diversity
rarefaction_curve_data_summary <- ddply(rarefaction_curve_data, c('Depth', 'SampleID', 'measures'),
                                        summarise, 
                                        Alpha_diversity_mean = mean(Alpha_diversity), 
                                        Alpha_diversity_sd = sd(Alpha_diversity))
# Add sample data
rarefaction_curve_data_summary_verbose <- merge(rarefaction_curve_data_summary, 
                                                data.frame(sample_data(ps.Phy)), 
                                                by.x = 'SampleID', by.y = 'row.names')
rarefaction_curve_data_summary_verbose <- rarefaction_curve_data_summary_verbose[, -1]
# plot out rarefaction curve
ggplot(rarefaction_curve_data_summary_verbose, aes(x = Depth, y = Alpha_diversity_mean, 
                                                   ymin = Alpha_diversity_mean - Alpha_diversity_sd, 
                                                   ymax = Alpha_diversity_mean + Alpha_diversity_sd,
                                                   color = SampleID, group = SampleID)) +
  scale_fill_brewer(palette = "Set2") + 
  geom_line()+
  geom_pointrange(size=0.1)+
  facet_wrap(facets = ~ measures, scales = "free")
# export the library size to a csv file
write.csv(sample_sums(ps.Phy05), file.path(path, "Jan/library_size_ps.Phy05.csv"))

# The diversity leveled out after 2000 seqs per sample, rarefy at 6100 reads
# to keep the sample with the fewest reads
ps.Phy.rare <- rarefy_even_depth(ps.Phy05, sample.size = 6100, replace = TRUE, 
                                 rngseed = 123 , trimOTUs = TRUE, verbose = TRUE) 
ps.Phy.rare #  175 taxa and 29 samples  # no OTU were exclude 
```


## Divide the ps object for milk and cheese
### For taxonomy analysis based on "ps.Phy.glom"
### For alpha and beta analysis based on "ps.xxxx.rare"
```{r}
# Clean up the taxonomy level
## If set at "REC" level, won't glom
ps.Phy.glom <- tax_glom(ps.Phy05, taxrank = "Genus", NArm = FALSE) 
ps.Phy.glom # 89 taxa and 29 samples
RECps <- dget("D:/src/Marco_Lab/Cheese1_R/FUN_RECps.R")
ps.Phy.REC <- RECps(TaxTab, ps.Phy.glom)
ps.Phy.REC # 89 taxa and 29 samples

# Subset to contain milk samples 
ps.milk <- subset_samples(ps.Phy.REC, SampleType %in% c("HTST_feed", "HTST_milk"))
ps.milk #  89 taxa and 18 samples 
ps.milk.rare <- rarefy_even_depth(ps.milk, sample.size = 6100, replace = TRUE, 
                                 rngseed = 123 , trimOTUs = TRUE, verbose = TRUE) 
ps.milk.rare # 89 taxa and 18 sampless  

# Subset to contain cheese samples ()
ps.cheese <- subset_samples(ps.Phy.REC, SampleType %in% "Pilot_cheese_5D")
ps.cheese #  89 taxa and 11 samples 
ps.cheese.rare <- rarefy_even_depth(ps.cheese, sample.size = 6100, replace = TRUE,
                                    rngseed = 123 , trimOTUs = TRUE, verbose = TRUE) 
ps.cheese.rare #  14 taxa and 11 samples   # 71 OTU were excluded 
ps.cheese.rarenoL <- subset_taxa(ps.cheese.rare, !Genus %in% "Lactococcus")
ps.cheese.rarenoL # 13 taxa and 11 samples
```


## Taxonomy analysis
The goal is (1) Confirm that the isolates do exist in the milk that they were isolated 
from (2) The pilot cheeses made with the isolate had similar slit profile 
(3) the milk containing the isolates had similar slits profile [but I don't]
no slits samples from the same cheese study 2 
```{r}
# Define function to make Bar plots 
#### Bar plot #####
SlitBar <- function(ps, var1, var2, taxa, mycol, path.out, w, h, x){  
  ps <- ps %>% transform_sample_counts(function(x) x/sum(x) ) 
  
  TaxTab <- tax_table(ps) %>% as.data.frame()
  taxa_names(ps) <- TaxTab$REC
  allTaxa <- taxa_names(ps)
  ps.other <- prune_taxa(allTaxa[!(allTaxa %in% taxa)], ps)
  taxa.other <- ps.other@tax_table[,6] %>% as.character() # 6 for Genus level 
  
  # change the taxa that are not the expected taxa to "Other" 
  TaxTab2 <- psmelt(ps)
  # merge/average per Sample and CheeseOutcome
  TaxTab2_agg <- aggregate(Abundance ~ TaxTab2[[var1]] + TaxTab2[[var2]] + REC,
                           data = TaxTab2,
                           mean)
  colnames(TaxTab2_agg)[1] <- var1
  colnames(TaxTab2_agg)[2] <- var2
  TaxTab2_agg$REC <- as.character(TaxTab2_agg$REC)
  TaxTab2_agg[TaxTab2_agg$REC %in% taxa.other,]$REC <- "Other"
  
  TaxTab2_agg$REC <- factor(TaxTab2_agg$REC, levels = taxa)
  TaxTab2_agg[[var1]] <- factor(TaxTab2_agg[[var1]])
  TaxTab2_agg[[var2]] <- factor(TaxTab2_agg[[var2]])
  
  pdf(path.out, w, h)
  p <- ggplot(TaxTab2_agg, aes(x = get(var1), y = Abundance, fill = REC)) +
    geom_bar(stat = "identity") + 
    scale_fill_manual(values = mycol)+
    theme_bw(base_size = 20) +
    facet_grid(~ get(var2), scales = "free_x")+
    # Remove x axis title
    theme(axis.title.x = element_blank(), axis.text.x = element_text(angle = 90, hjust = 1),
          text = element_text(size = 16)) + 
    guides(fill = guide_legend(reverse = FALSE, keywidth = 1, keyheight = 1)) +
    ylab("Relative abundance")
  
  # convert ggplot object to grob object
  gp <- ggplotGrob(p)
  # optional: take a look at the grob object's layout 
  # gtable::gtable_show_layout(gp)
  # get gtable columns corresponding to the facets 
  facet.columns <- gp$layout$l[grepl("panel", gp$layout$name)]
  # get the number of unique x-axis values per facet (1 & 3, in this case)
  x.var <- sapply(ggplot_build(p)$layout$panel_scales_x, 
                  function(l) length(l$range$range))
  # change the relative widths of the facet columns based on how many unique 
  # x-axis values are in each facet
  gp$widths[facet.columns] <- gp$widths[facet.columns] * x.var
  # plot result
  grid::grid.draw(gp)
  dev.off()
}


comm15 <- c("Acinetobacter", "Bacillus", "Corynebacterium", "Clostridium",
            "Enterococcus", "Leuconostoc",  "Lactobacillus", "Lactococcus", "Macrococcus",
            "Mycoplasma", "Pseudomonas", "Staphylococcus", "Streptococcus",
            "Thermus", "Turicibacter", "Other")
col15 = c("#A6CEE3", "#438EC0", "#63A8A0", "#98D277", "#3BA432", "#B89B74",
          "#F16667", "#E62F27", "#F9A963", "#FE982C", "#ED8F47", "#C3AAD2",  
          "#7D54A5", "#B9A499", "#EAD27A", "#B15928")
SlitBar(ps.milk, var1 = "SampleID", var2 = "SampleType",
        taxa = comm15, mycol = col15, 
        path.out = file.path(path, "figs/milk_SampleType_SampleID.pdf"), 6, 4.5)
SlitBar(ps.cheese, var1 = "Bacterial_isolate", var2 = "SampleType",
        taxa = comm15, mycol = col15,
        path.out = file.path(path, "figs/cheese_Bacterial_isolate_SampleType.pdf"), 6, 9)


# comm14 doesn't have Lactococcus 
comm14 <- c("Acinetobacter", "Bacillus", "Corynebacterium", "Clostridium",
            "Enterococcus", "Leuconostoc", "Lactobacillus", "Macrococcus",
            "Mycoplasma", "Pseudomonas", "Staphylococcus", "Streptococcus",
            "Thermus", "Turicibacter", "Other")
col14 = c("#A6CEE3", "#438EC0", "#63A8A0", "#98D277", "#3BA432",
          "#F16667", "#E62F27", "#F9A963", "#FE982C", "#ED8F47", "#C3AAD2",
          "#7D54A5", "#B9A499", "#EAD27A", "#B15928")
SlitBar(ps.cheese, var1 = "Bacterial_isolate", var2 = "SampleType",
        taxa = comm14, mycol = col14,
        path.out = file.path(path, "figs/cheese_Bacterial_isolate_SampleType.pdf"), 6, 9)


```


