---
title: "MC_paper2_phyloseq_import"
author: "Zeya Zhengyao Xue"
date: "January 14, 2019"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.path = "figs/")
```

This file follows the analysis in QIIME2, which imports mapping file, feature table,
taxonomy and tree as a 4-component phyloseq object. 

## Setting up packages and working directory 
```{r}
library(phyloseq);packageVersion("phyloseq")
library(vegan);packageVersion("vegan")
library(ggplot2);packageVersion("ggplot2")
library(ggpubr); packageVersion("ggpubr") #  ggplot2 based publication ready fig
library(reshape2);packageVersion("reshape2")
library(cowplot);packageVersion("cowplot")
library(plyr)
library(dplyr)

path <- "~/Google Drive File Stream/My Drive/UC_Davis/Marco_lab/milk_microbiota/Mock_community/MC_paper2_QIIME2/"
```

## Import QIIME2 output and make phyloseq object
2/5/19: add Phase 3 results and import as the same ps object
```{r}
# Transpose the QIIME2 output in excel
# For the theoretical values, I can adjust its absolute reads to suit data set by
# changing values in the feature table
SeqTab <- read.table(file.path(path, "feature_table/5file-combined_table-dada2-mc2.txt"), header = TRUE, stringsAsFactors = FALSE)
colnames(SeqTab) <- gsub("X","",colnames(SeqTab))
row.names(SeqTab) <- SeqTab$OTUID
SeqTab <- SeqTab[,-1]
SeqTab <- as.matrix.data.frame(SeqTab)

# Read in metadata file
samdf <- read.csv(file.path(path,"mapping/5file-MC_paper2_samdf.csv"))
rownames(samdf) <- samdf$SampleID

# Read in exported rooted tree 
tree <- read_tree(file.path(path,"5file-tree.nwk"))

# Parse out taxonomic assignment in excel and remove confidence column
# keep only taxa included in the "feature-table-mc2.csv" file
TaxTab <- read.table(file.path(path,"5file-taxonomy-mc2.tsv"), header = TRUE, sep = '\t', na.strings = NA)
rownames(TaxTab) <- TaxTab$FeatureID
TaxTab <- TaxTab[,-1]
TaxTab <- as.matrix.data.frame(TaxTab)

# merge as the phyloseq ready to use
ps <- phyloseq(otu_table(SeqTab, taxa_are_rows = TRUE), tax_table(TaxTab),sample_data(samdf), phy_tree(tree))
ps # 1052 taxa and 212 samples 

# Filter out singleton
ps <- filter_taxa(ps, function (x) {sum(x > 0) > 1}, prune=TRUE)
ps # 1049 taxa and 212 samples
write.csv(ps@otu_table, file.path(path,"feature_table/5file-feature-table-mc2.csv"))
```

## Inspect Library Sizes
```{r}
#add a colum for read counts/library size
samdf$LibrarySize <- sample_sums(ps)
#sort by the library size in increasing order
samdf <- samdf[order(samdf$LibrarySize),]
samdf$Index <- seq(nrow(samdf))
ggplot(samdf, aes(x=Index, y=LibrarySize, color=SampleOrCtrl))+geom_point()
```
As expected, some of the UHT_NC had pretty high read coverage.
Also, I decided to not do decontam with the MC data because I know already which
taxa are contamination and which taxa are expected.


## Filter ASVs based on taxonomy and abundance 
```{r}
# Show available ranks in the dataset
rank_names(ps)
# Create table, number of features for each phylum
table(tax_table(ps)[, "Phylum"], exclude = NULL)
# remove asv that was not assigned at phylum level
ps.Phy <- subset_taxa(ps, !is.na(Phylum) & !Phylum %in% c(""))
ps.Phy # 1013 taxa and 212 samples
# Explore abundance to decide filter threshold
## Compute prevalence of each feature, store as data.frame
prevdf <- apply(X = otu_table(ps.Phy),
                MARGIN = ifelse(taxa_are_rows(ps.Phy), yes = 1, no = 2),
                FUN = function(x)(sum(x>0)))
# Add taxonomy and total read counts to this data.frame
prevdf <- data.frame(Prevalence = prevdf,
                     TotalAbundance = taxa_sums(ps.Phy),
                     tax_table(ps.Phy))
# plot the abudance per phylum 
ggplot(prevdf, aes(TotalAbundance, Prevalence / nsamples(ps.Phy),color=Phylum)) +
  # Include a guess for parameter
  geom_hline(yintercept = 0.01,  linetype = 2) + geom_point(size = 2, alpha = 0.7) +
  scale_x_log10() +  xlab("Total Abundance") + ylab("Prevalence [Frac. Samples]") +
  facet_wrap(~Phylum) + theme(legend.position="none")
# Most bacteria are in the Actinobacteria, Bacteroidetes, Firmircutes and Proteobacteria
# But I don't actually have Bacteroidetes members...

# Remove very low abudance ASVs independent of sample prevalence
x = taxa_sums(ps.Phy)
keepTaxa = which((x / sum(x)) > 0.00005)
ps.Phy05 <- prune_taxa(names(keepTaxa), ps.Phy)
ps.Phy05 # 197 taxa and 212 samples
```

## Determine rarefaction level for Alpha and Beta analysis later on
```{r}
set.seed(123)
# Define function to calculate alpha diversity and rarefaction levels
calculate_rarefaction_curves <- function(psdata, measures, depths) {
  estimate_rarified_richness <- function(psdata, measures, depth) {
    if(max(sample_sums(psdata)) < depth) return()
    psdata <- prune_samples(sample_sums(psdata) >= depth, psdata)
    rarified_psdata <- rarefy_even_depth(psdata, depth, verbose = FALSE)
    alpha_diversity <- estimate_richness(rarified_psdata, measures = measures)
    # as.matrix forces the use of melt.array, which includes the Sample names (rownames)
    molten_alpha_diversity <- melt(as.matrix(alpha_diversity), varnames = c("SampleID", 'measures'), value.name = 'Alpha_diversity')
    molten_alpha_diversity
  }
  names(depths) <- depths # this enables automatic addition of the Depth to the output by ldply
  rarefaction_curve_data <- ldply(depths, estimate_rarified_richness, psdata = psdata, measures = measures, .id = 'Depth', .progress = ifelse(interactive(), 'text', 'none'))
  #convert Depth from factor to numeric
  rarefaction_curve_data$Depth <- as.numeric(levels(rarefaction_curve_data$Depth))[rarefaction_curve_data$Depth]
  rarefaction_curve_data
}
rarefaction_curve_data <- calculate_rarefaction_curves(ps.Phy05, c("Observed", "Shannon","Simpson"), 
                                                       rep(c(1, 2500, 5000, 7500, 10000), each = 10))
rarefaction_curve_data$SampleID <- gsub("X","",rarefaction_curve_data$SampleID)
# summarize alpha diversity
rarefaction_curve_data_summary <- ddply(rarefaction_curve_data, c('Depth', 'SampleID', 'measures'), 
                                        summarise, 
                                        Alpha_diversity_mean = mean(Alpha_diversity), 
                                        Alpha_diversity_sd = sd(Alpha_diversity))
# Add sample data
rarefaction_curve_data_summary_verbose <- merge(rarefaction_curve_data_summary, 
                                                data.frame(sample_data(ps.Phy)), 
                                                by.x = 'SampleID', by.y = 'row.names')
rarefaction_curve_data_summary_verbose <- rarefaction_curve_data_summary_verbose[, -1]

# plot out rarefaction curve
ggplot(rarefaction_curve_data_summary_verbose, aes(x = Depth, y = Alpha_diversity_mean, 
                                                   ymin = Alpha_diversity_mean - Alpha_diversity_sd, 
                                                   ymax = Alpha_diversity_mean + Alpha_diversity_sd,
                                                   color = SampleID, group = SampleID)) +
  scale_fill_brewer(palette = "Set2") + 
  geom_line()+
  geom_pointrange(size=0.1)+
  theme(legend.position="none") + #  remove legend
  facet_wrap(facets = ~ measures, scales = "free")
# export the library size to a csv file
write.csv(sample_sums(ps.Phy05), file.path(path, "mapping/library_size_ps.Phy05_5file.csv"))

# The diversity leveled out after 2500 seqs per sample, rarefy at 3990
# to keep the sample with the fewest reads that is no a NC (MC.50.2)
ps.Phy.rare <- rarefy_even_depth(ps.Phy05, sample.size = 3990, replace = TRUE, 
                                 rngseed = 123 , trimOTUs = TRUE, verbose = TRUE) 
ps.Phy.rare # 197 taxa and 203 samples
```

## Divide the ps object for different dataset 
### For taxonomy analysis based on "ps.Phy.REC"
```{r include=FALSE}
# Clean up the taxonomy level
#make the deepest taxonomic identification in TaxTab as the recommened taxonomy (REC)
RECps <- function(x, ps) {
  TaxTab2 <- as.data.frame(x)
  
  list.g <- as.character(TaxTab2$Genus)
  list.f <- as.character(TaxTab2$Family)
  list.o <- as.character(TaxTab2$Order)
  list.c <- as.character(TaxTab2$Class)
  list.p <- as.character(TaxTab2$Phylum)
  list.k <- as.character(TaxTab2$Kingdom)
  list.REC <- character(length(list.g))
  
  for(i in 1:dim(TaxTab2)[1]){
    G = which(TaxTab2$Genus[i] == "")
    F = which(TaxTab2$Family[i] == "")
    O = which(TaxTab2$Order[i] == "")
    C = which(TaxTab2$Class[i] == "")
    P = which(TaxTab2$Phylum[i] == "")
    K = which(TaxTab2$Kingdom[i] == "")
    if(length(G) == 0){
      list.REC[i] <- list.g[i]
    } else if(length(F) == 0){
      list.REC[i] <- list.f[i]
    } else if(length(O) == 0){
      list.REC[i] <- list.o[i]
    } else if(length(C) == 0){
      list.REC[i] <- list.c[i]
    } else if(length(P) == 0){
      list.REC[i] <- list.p[i]
    } else if(length(K) == 0){
      list.REC[i] <- list.k[i]
    } else
      list.REC[i] <- "meow"
  }
  
  TaxTab2$REC <- list.REC
  TaxTab2$REC <- factor(TaxTab2$REC)
  merge_phyloseq(ps, TaxTab2 %>% as.matrix() %>% tax_table())
}

ps.Phy.glom <- tax_glom(ps.Phy05, taxrank = "Genus", NArm = FALSE)
ps.Phy.REC <- RECps(TaxTab, ps.Phy.glom)
ps.Phy.REC # 100 taxa and 212 samples


# Define function to get the average and raw value of the feature table 
AveFeatTab <- function(ps){
  df <- psmelt(ps)
  df.cast <- dcast(df, REC ~ For_AVE, mean, value.var = "Abundance")
  df.cast[, -1] <- lapply( df.cast[ , -1], function(x) x/sum(x, na.rm=TRUE) )
  df.cast
}
FeatTab <- function(ps){
  df <- psmelt(ps)
  df.cast <- dcast(df, For_AVE + SampleID ~ REC, value.var = "Abundance")
  df.cast
}


# 1. DNA extraction lysis method using the Total kit; BCMC1
samdf_BCMC1_total_lyse <- read.csv(file.path(path, "mapping/MC_paper2_samdf_BCMC1_total_lyse.csv"))
rownames(samdf_BCMC1_total_lyse) <- samdf_BCMC1_total_lyse$SampleID
ps1 <- phyloseq(sample_data(samdf_BCMC1_total_lyse), otu_table(ps.Phy.REC),
                tax_table(ps.Phy.REC), phy_tree(ps.Phy.REC))
ps1 # 91 taxa and 23 samples
write.csv(AveFeatTab(ps1), file.path(path, "feature_table/FeatTab_BCMC1_total_lyseAVE.csv"))


# 2. DNA extraction kit with MoBio
samdf_BCMC1_MoBio <- read.csv(file.path(path, "mapping/MC_paper2_samdf_BCMC1_MoBio.csv"))
rownames(samdf_BCMC1_MoBio) <- samdf_BCMC1_MoBio$SampleID
ps2 <- phyloseq(sample_data(samdf_BCMC1_MoBio), otu_table(ps.Phy.REC),
                tax_table(ps.Phy.REC), phy_tree(ps.Phy.REC))
ps2 # 91 taxa and 6 samples
write.csv(AveFeatTab(ps2), file.path(path, "feature_table/FeatTab_BCMC1_MoBioAVE.csv"))

# 3. DNA extraction kit choice on 10 ml UHT milk; BCMC2
samdf_BCMC2_kit_10ml <- read.csv(file.path(path, "mapping/MC_paper2_samdf_BCMC2_kit_10ml.csv"))
rownames(samdf_BCMC2_kit_10ml) <- samdf_BCMC2_kit_10ml$SampleID
ps3 <- phyloseq(sample_data(samdf_BCMC2_kit_10ml), otu_table(ps.Phy.REC),
                tax_table(ps.Phy.REC), phy_tree(ps.Phy.REC))
ps3 # 91 taxa and 30 samples
write.csv(AveFeatTab(ps3), file.path(path, "feature_table/FeatTab_BCMC2_kit_10mlAVE.csv"))

# 4. PMA treatment
samdf_PMA <- read.csv(file.path(path, "mapping/MC_paper2_samdf_PMA.csv"))
rownames(samdf_PMA) <- samdf_PMA$SampleID
ps4 <- phyloseq(sample_data(samdf_PMA), otu_table(ps.Phy.REC),
                tax_table(ps.Phy.REC), phy_tree(ps.Phy.REC))
ps4 # 91 taxa and 15 samples
write.csv(AveFeatTab(ps4), file.path(path, "feature_table/FeatTab_PMA.csv"))

# 5. Sample storage
samdf_sample_storage <- read.csv(file.path(path, "mapping/MC_paper2_samdf_sample_storage.csv"))
rownames(samdf_sample_storage) <- samdf_sample_storage$SampleID
ps5 <- phyloseq(sample_data(samdf_sample_storage), otu_table(ps.Phy.REC),
                tax_table(ps.Phy.REC), phy_tree(ps.Phy.REC))
ps5 # 91 taxa and 24 samples
write.csv(AveFeatTab(ps5), file.path(path, "feature_table/FeatTab_sample_storage.csv"))

# 6. Sample Volume
samdf_total_vol <- read.csv(file.path(path, "mapping/MC_paper2_samdf_total_vol.csv"))
rownames(samdf_total_vol) <- samdf_total_vol$SampleID
ps6 <- phyloseq(sample_data(samdf_total_vol), otu_table(ps.Phy.REC),
                tax_table(ps.Phy.REC), phy_tree(ps.Phy.REC))
ps6 # 91 taxa and 18 samples
write.csv(AveFeatTab(ps6), file.path(path, "feature_table/FeatTab_total_vol.csv"))

# 7. phase 3 kit, cleanup and lysing method 
samdf_phase3 <- read.csv(file.path(path, "mapping/phase3_samdf.csv"))
rownames(samdf_phase3) <- samdf_phase3$SampleID
ps7 <- phyloseq(sample_data(samdf_phase3), otu_table(ps.Phy.REC),
                tax_table(ps.Phy.REC), phy_tree(ps.Phy.REC))
ps7 # 100 taxa and 51 samples
write.csv(AveFeatTab(ps7), file.path(path, ("feature_table/FeatTab_phase3.csv")))


# create ps list with all phyloseq objects
psList <- list(ps1, ps2, ps3, ps4, ps5, ps6, ps7)
names(psList) <- c(1:7)

# use the function to write feature table (not average) list and write out csv
FeatTab.list <- lapply(psList, FeatTab)
mapply(write.csv, FeatTab.list, file = paste0(path, "feature_table/FeatTab_", names(FeatTab.list), ".csv"))
```

#### Taxonomy plot
```{r}
TaxBar <- function(ps, var1, var2, lvl = NULL, lvl2 = NULL, w, h, path.out){
  ExpTaxa <- c("Bacillaceae","Bacillus","Corynebacterium","Clostridiaceae",
               "Clostridium","Enterococcus","Escherichia","Lactococcus",
               "Pseudomonas","Staphylococcus","Streptococcus") 
  
  ps <-  ps %>% transform_sample_counts(function(x) x/sum(x) )  
  TaxTab <- tax_table(ps) %>% as.data.frame()
  taxa_names(ps) <- TaxTab$REC 
  allTaxa <- taxa_names(ps)
  ps.other <- prune_taxa(allTaxa[!(allTaxa %in% ExpTaxa)], ps)
  taxa.other <- ps.other@tax_table[,8] %>% as.character() # 8 for REC level 
  
  # change the taxa that are not the expected taxa to "Other" 
  TaxTab2 <- psmelt(ps)
  # merge/average per Sample and CheeseOutcome
  TaxTab2_agg <- aggregate(Abundance ~ TaxTab2[[var1]] + TaxTab2[[var2]] + REC,
                           data = TaxTab2,
                           mean)
  colnames(TaxTab2_agg)[1] <- var1
  colnames(TaxTab2_agg)[2] <- var2
  TaxTab2_agg$REC <- as.character(TaxTab2_agg$REC)
  TaxTab2_agg[TaxTab2_agg$REC %in% taxa.other,]$REC <- "Other"
  
  # Set colors for plotting
  mycol = c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c",
            "#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928")
  
  # Set orders for taxonomy and sampleID
  TaxTab2_agg$REC = factor(TaxTab2_agg$REC, levels = c(ExpTaxa, "Other"))
  if (!is.null(lvl)) TaxTab2_agg[[var1]] <- factor(TaxTab2_agg[[var1]], levels = lvl)
  if (!is.null(lvl2)) TaxTab2_agg[[var2]] <- factor(TaxTab2_agg[[var2]], levels = lvl2)
  
  pdf(path.out, width = w, height = h)
  p <- ggplot(TaxTab2_agg, aes(x = get(var1), y = Abundance, fill = REC)) +
    facet_grid(. ~ get(var2), scales = "free_x") + 
    geom_bar(stat = "identity") + 
    scale_fill_manual(values = mycol)+
    theme_bw(base_size = 15)+
    guides(fill = guide_legend(reverse = FALSE, keywidth = 1, keyheight = 1)) +
    ylab("Relative proportion")
  
  # convert ggplot object to grob object
  gp <- ggplotGrob(p)
  # optional: take a look at the grob object's layout 
  # gtable::gtable_show_layout(gp)
  # get gtable columns corresponding to the facets 
  facet.columns <- gp$layout$l[grepl("panel", gp$layout$name)]
  # get the number of unique x-axis values per facet (1 & 3, in this case)
  x.var <- sapply(ggplot_build(p)$layout$panel_scales_x, 
                  function(l) length(l$range$range))
  # change the relative widths of the facet columns based on how many unique 
  # x-axis values are in each facet
  gp$widths[facet.columns] <- gp$widths[facet.columns] * x.var
  # plot result
  grid::grid.draw(gp)
  dev.off()
}

# Read in sample ID order 
lvl.ID <- read.csv(file.path(path, "mapping/phase3_sample_orders.csv"), header = FALSE) 
lvl.ID$V1 <- as.character(lvl.ID$V1)
TaxBar(ps7, var1 = "SampleID", var2 = "Kit", lvl = lvl.ID$V1,
       path.out = file.path(path,"feature_table/ps7_SampleID_Kit.pdf"), w = 9, h = 5)
TaxBar(ps7, var1 = "SampleID", var2 = "Lysis", lvl = lvl.ID$V1, 
       lvl2 = c("Expected", "Bead beat: 2min x 6.5m/s", "Vortex: 15min", 
                "Chemical: 1hr", "Bead beat: 10s x 4m/s",
                "Chemical + Bead beat: 1hr + 10s x 4m/s",
                "Vortex: 30s", "Chemical + Vortex: 1hr + 30s "),
       path.out = file.path(path,"feature_table/ps7_SampleID_Lysis.pdf"), w = 9, h = 5)


# Plot for sample storage conditions (ps5)
TaxBar(subset_samples(ps5, For_AVE %in% c("Glycerol","PBS2","Expected2")),  # subset to include only BCMC2 samples 
       var1 = "SampleID", var2 = "For_AVE",
       lvl = c("Theo2.1","Theo2.2","Theo2.3",
               "MC.PBS.1","MC.PBS.2","MC.PBS.3",
               "MC.25.glycerol.1","MC.25.glycerol.2","MC.25.glycerol.3"), 
       lvl2 = c("Expected2","PBS2", "Glycerol"),
       path.out = file.path(path, "feature_table/ps5_SampleID_For_AVE.pdf"), 5, 5)

# Plot for milk volumne collection (ps6)
TaxBar(subset_samples(ps6, SampleID != "Theo2.2" & SampleID != "Theo2.3" &  
                        # subset to contain only one expected value
                        SampleID != "10TB.1" & SampleID != "10TB.2" & SampleID != "10TB.3"),
                        # subset to include only one set of 10ml samples
       var1 = "SampleID", var2 = "For_AVE",
       lvl = c("Theo2.1","MC.30ml.UHT.1","MC.30ml.UHT.2","MC.30ml.UHT.3",
               "MC.10ml.UHT.1","MC.10ml.UHT.2","MC.10ml.UHT.3",
               "MC.1ml.UHT.1","MC.1ml.UHT.2","MC.1ml.UHT.3","200TB.1","200TB.2","200TB.3"),
       lvl2 = c("Expected","30ml","10ml","1ml","200uL"),
       path.out = file.path(path, "feature_table/ps6_SampleID_For_AVE.pdf"),7.5,5)

```


### For alpha and beta div based on ps.Phy.rare
```{r include=FALSE}
ps1.rare <- rarefy_even_depth(ps1, sample.size = 3990, replace = TRUE, rngseed = 123 , trimOTUs = TRUE, verbose = TRUE) 
ps2.rare <- rarefy_even_depth(ps2, sample.size = 3990, replace = TRUE, rngseed = 123 , trimOTUs = TRUE, verbose = TRUE) 
ps3.rare <- rarefy_even_depth(ps3, sample.size = 3990, replace = TRUE, rngseed = 123 , trimOTUs = TRUE, verbose = TRUE) 
ps4.rare <- rarefy_even_depth(ps4, sample.size = 3990, replace = TRUE, rngseed = 123 , trimOTUs = TRUE, verbose = TRUE) 
ps5.rare <- rarefy_even_depth(ps5, sample.size = 3990, replace = TRUE, rngseed = 123 , trimOTUs = TRUE, verbose = TRUE) 
ps6.rare <- rarefy_even_depth(ps6, sample.size = 3990, replace = TRUE, rngseed = 123 , trimOTUs = TRUE, verbose = TRUE) 
ps7.rare <- rarefy_even_depth(ps7, sample.size = 3990, replace = TRUE, rngseed = 123 , trimOTUs = TRUE, verbose = TRUE) 

ps1.rare #  27 taxa and 23 samples
ps2.rare # 10 taxa and 6 samples
ps3.rare # 55 taxa and 29 samples
ps4.rare # 61 taxa and 15 samples
ps5.rare # 18 taxa and 24 samples
ps6.rare # 51 taxa and 18 samples
ps7.rare # 39 taxa and 51 samples
```


#### Beta diversity 
```{r include=FALSE}
# Define function to get distance matrix (not include unifrac)
# I have to use distance() from vegan packages due to in compatibility 
# https://github.com/joey711/phyloseq/issues/918
DistTab <- function(ps, DistMethod){
  df <- psmelt(ps)
  df.cast <- dcast(df, For_AVE + SampleID ~ REC, value.var = "Abundance")
  df.cast <- df.cast[,-1]
  row.names(df.cast) <- df.cast[,1]
  df.cast <- df.cast[,-1]
  dist <- vegdist(df.cast, method = DistMethod) %>% as.matrix()
}

# create ps list with all phyloseq objects
psList.rare <- list(ps1.rare, ps2.rare, ps3.rare, ps4.rare, ps5.rare, ps6.rare, ps7.rare)
names(psList.rare) <- c(1:7)

# use the function to write bray distance list and write out as csv files
BrayList <- lapply(psList.rare, DistTab, DistMethod = "bray")
mapply(write.csv, BrayList, file = paste0(path, "distance/bray_", names(psList.rare), ".csv"))

# write out weighted list as well
WeightList <- lapply(psList.rare, UniFrac, weighted = TRUE)
WeightList <- lapply(WeightList, as.matrix)
mapply(write.csv, WeightList, file = paste0(path, "distance/weighted_", names(psList.rare), ".csv"))


# Define function to draw cluster dendrogram
DistDendro <- function(dist, ClusterMethod, path.out, w, h){
  pdf(path.out, w, h)
  hclust(as.dist(dist), method = ClusterMethod) %>% plot() %>% print()
  dev.off()
}


# dendrogram for ps5.rare
Bray5 <- DistTab(subset_samples(ps5.rare, For_AVE %in% c("Glycerol","PBS2","Expected2")), "bray")
DistDendro(dist = Bray5, ClusterMethod = "average",
           path.out = file.path(path, "distance/UPGMA_bray.pdf"), w = 7, h = 4.5)
DistDendro(dist = UniFrac(subset_samples(ps5.rare, For_AVE %in% c("Glycerol","PBS2","Expected2")), weighted = TRUE),
           ClusterMethod = "average",
           path.out = file.path(path, "distance/UPGMA_weighted.pdf"), w = 7, h = 4.5)

```


```{r}
# Define function to make box plot and add p-values to the plot 
## based on the package called "ggpubr"
DistBox <- function(df, DistMethod, path.out, w, h) {
  df$Description <- factor(df$Description, 
                         levels = c("10TB", "10TV", "10TC",
                                    "10CB", "10CV", "10CC",
                                    "10UB", "10UV", "10UC",
                                    "M4W","M4R","ML4W","ML4R","MVW","MVR","MLVW","MLVR",
                                    "P4W","P4R","PL4W","PL4R","PVW","PVR","PLVW","PLVR"))
  df$Kit <- factor(df$Kit, levels = c("Total","Core","Ultra2",
                                    "Total_phase3", "Total_ProteinaseK"))
  df$Lysis <- factor(df$Lysis, 
                   levels = c("Bead beat: 2min x 6.5m/s", "Vortex: 15min",
                              "Chemical: 1hr", "Bead beat: 10s x 4m/s",
                              "Chemical + Bead beat: 1hr + 10s x 4m/s",
                              "Vortex: 30s", "Chemical + Vortex: 1hr + 30s "))
  
  pdf(path.out, w, h )
  (ggboxplot(df, x = "Description", y = "ave", ylab = DistMethod,
             fill = "Lysis", palette = "Set3",
             short.panel.labs = FALSE, 
             font.label = list(size = 18, face = "plain"),
             ggtheme = theme_bw()) + 
     stat_compare_means(method = "t.test", ref.group = "10TB",
                        hide.ns = TRUE,  label = "p.signif")) %>% print
  dev.off()
  
  # ns: p > 0.05
  # *: p <= 0.05
  # **: p <= 0.01
  # ***: p <= 0.001
  # ****: p <= 0.0001
}


# Import organized and subsetted (only extraction) distance csv file for making bar plots
Bray.ext <- read.csv(file.path(path, "distance/organized_distance_extraction_bray.csv"))
DistBox(Bray.ext, DistMethod = "Bray-Curtis dissimilarity",
        path.out = file.path(path,"distance/Bray.ext.pdf"), w = 8, h = 4.5)

weighted.ext <- read.csv(file.path(path, "distance/organized_distance_extraction_weighted.csv"))
DistBox(weighted.ext, DistMethod = "Weighted UniFrac distance",
        path.out = file.path(path,"distance/Weigted.ext.pdf"), w = 8, h = 4.5)
```

```{r}
# Define function to plot 2D beta diversity dot plot
BetaPlot <- function(ps, ClusterMethod, DistMethod, var1, w, h, path.out){
  ps.ord <- ordinate(ps, method = ClusterMethod, distance = DistMethod)
  
  pdf(path.out, w, h)
  print(plot_ordination(ps, ps.ord, color = var1) + 
          geom_point(size=3)+ 
          scale_color_brewer(palette="Paired")+
          ggtitle("")+
          ylab("NMDS2")+ 
          xlab("NMDS1")+
          theme_bw(base_size = 15))
  dev.off()
}


# ps6 (sample volume)
BetaPlot(subset_samples(ps6.rare, SampleID != "10TB.1" & SampleID != "10TB.2" & SampleID != "10TB.3"),
         ClusterMethod = "NMDS", DistMethod = "bray", var1 = "For_AVE",
         path.out = file.path(path, "beta/ps6_NMDS_bray.pdf"), 5, 3.6)

# ps 4 (PMA)
BetaPlot(ps4.rare, ClusterMethod = "NMDS", DistMethod = "bray", var1 = "For_AVE",
         path.out = file.path(path, "beta/ps4_NMDS_bray.pdf"), 5, 3.6)

```


#### Alpha diversity
```{r}
# Define function that plots out alpha box plot as well as p values
AlphaBox <- function(ps, alpha_measures, var1, var, lvl, path.out, w, h){
  df <- estimate_richness(ps, split = TRUE, measures = alpha_measures) 
  row.names(df) <- gsub("X","",row.names(df) )
  # add sample metadata information
  df <- merge(df, data.frame(sample_data(ps)), by.x = 'row.names', by.y = 'row.names')
  df <- df[, -1]
  # Melt dataframe for plotting figures
  dfm <- melt(df, id.vars = c("SampleID", var),
              variable.name = "measure", value.name = "value")
  dfm[[var1]] <- factor(dfm[[var1]], levels = lvl)
  
  pdf(path.out, w, h)
  p<- ggboxplot(dfm, x = var1, y = "value", add = "jitter", palette = "Set3",
                font.label = list(size = 18, face = "plain"), ggtheme = theme_bw())+
    stat_compare_means(method = "t.test", ref.group = "Expected", 
                       hide.ns = TRUE,  label = "p.signif")

  facet(p, facet.by = "measure", scales = "free") %>% print()
  dev.off()
}

# Alpha box plot on ps6 (sample volume)
AlphaBox(subset_samples(ps6.rare, SampleID != "10TB.1" & SampleID != "10TB.2" & SampleID != "10TB.3"),
         # subset to include only one set of 10ml samples 
         alpha_measures = c("Observed", "Shannon"),
         var1 = "For_AVE", var = c("KIT","For_AVE","STORAGE","MATRIX","PMA",
                                   "SampleOrCtrl","LYSING","Chemical_time",
                                   "Bead_beat_speed_time","vortex_time","Description"),
         lvl = c("Expected","30ml","10ml","1ml","200uL"),
         path.out = file.path(path, "alpha/ps6_ForAVE.pdf"), 4.5, 2.3)

# Alpha box plot on ps 4 (PMA)
AlphaBox(ps4.rare, alpha_measures = c("Observed", "Shannon"),
         var1 = "For_AVE", var = c("KIT","For_AVE","VOL","STORAGE","MATRIX","PMA",
                                   "SampleOrCtrl","LYSING","Chemical_time","Bead_beat_speed_time","vortex_time","Description"),
         lvl = c("Expected","Untreated","Live","Half","Dead"),
         path.out = file.path(path, "alpha/ps4_ForAVE.pdf"), 4.5, 2.3)

```



## qPCR results 
### PMA on single bacterial strain or gDNA 
```{r}
# PMA on E.coli gDNA 
PMA.conc <- read.csv(file.path(path, "qPCR/10min_conc.csv"))
gghistogram(PMA.conc, x = "Ct_diff",
            add = "mean", rug = TRUE, color = "Treatment", fill = "Treatment",
            palette = c("#00AFBB", "#E7B800"))
pdf(file.path(path, "qPCR/10min_conc.pdf"), 3.2, 3)
print(ggboxplot(PMA.conc, x = "Treatment", y = "Ct_diff",
                font.label = list(size = 18, face = "plain"), 
                ggtheme = theme_bw()) +
        stat_compare_means(method = "kruskal", hide.ns = TRUE, label = "p.signif"))
dev.off()

# PMA on 3 species strain 
PMA.T <- read.csv(file.path(path, "qPCR/50uM_time.csv"))
PMA.T$Cell_state <- factor(PMA.T$Cell_state, levels = c("Live", "Half", "Dead"))
## make a df to p value annotation
df.anno = compare_means(PerOf_untreated ~ Treatment, method = "kruskal.test",
                        group.by = "Species", data = PMA.T) %>% mutate(y_pos = 40)

pdf(file.path(path, "qPCR/50uM_time.pdf"), 6, 3)
print(ggboxplot(subset(PMA.T, PerOf_untreated != "NA"), 
                x = "Treatment", y = "PerOf_untreated", color = "Cell_state",
                font.label = list(size = 18, face = "plain"), 
                palette = "jco", ggtheme = theme_bw()) +
        facet_wrap(~Species, scales = "free_x"))
dev.off()
```


Percent recovery of GBS DNA with meconium extractions
generated from various extraction kits. Data are mean Â± S

