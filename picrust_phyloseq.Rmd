---
title: "picrust_phyloseq"
author: "Zeya Zhengyao Xue"
date: "October 5, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setting up 
```{r}
library(phyloseq);packageVersion("phyloseq")
library(biomformat);packageVersion("biomformat")
library(ggplot2);packageVersion("ggplot2")
library(reshape2)
library(cowplot)
library(plyr)
library(dplyr)
library(RColorBrewer)

# Define project path
path <- "G:/My Drive/UC_Davis/Marco_lab/milk_microbiota/Hilmar_weekly_samples/QIIME2/"
```


## Funtion level analysis
The starting point is a picrust .biom file generated using Galaxy.
```{r}
# Read the sample information data frame  
samdf <- read.csv(file.path(path, "mapping/Run1-5_samdf-mc2.csv"))
rownames(samdf) <- samdf$SampleID
# Read the function table 
funtab = read_biom(file.path(path, "picrust/Predicted_Function.biom"))
# Get taxonomy  
taxtab = as.matrix(observation_metadata(funtab), rownames.force=TRUE) 
taxtab = tax_table(taxtab)
# Add taxonomy to FunTab
funtab = as(biom_data(funtab), "matrix")
funtab = otu_table(funtab, taxa_are_rows=TRUE)

# Merge as one phyloseq object 
ps <- phyloseq(otu_table(funtab3,taxa_are_rows = FALSE),tax_table(taxtab), sample_data(samdf))
ps

# Following Bletz et al. 2016: Pathways with < 10 counts were removed from the table.
ps10 <- filter_taxa(ps, function(x) sum(x) > 10, TRUE)
ps10
```


## Subset to contain milk samples
```{r}
picr.milk <- subset_samples(ps100.rare, SampleType %in% c("HTST_milk","Raw_milk","HTST_feed"))
saveRDS(picr.milk,"picrust/picr.milk.rds")
picr.milk

#PMA treated sample
picr.milkY <- subset_samples(picr.milk, PMA %in% "Y")
saveRDS(picr.milkY,"picrust/picr.milkY.rds")
picr.milkY 
# HTST milk 
picr.milkY.htst <- subset_samples(picr.milkY, SampleType %in% "HTST_milk")
lefse.tbl.milkY.htst <- phyloseq_to_lefs(picr.milkY.htst)
write.csv(lefse.tbl.milkY.htst, "picrust/lefse-table/lefse.tbl.milkY.htst.csv")
# HTST feed
picr.milkY.feed <- subset_samples(picr.milkY, SampleType %in% "HTST_feed")
lefse.tbl.milkY.feed <- phyloseq_to_lefs(picr.milkY.feed)
write.csv(lefse.tbl.milkY.feed, "picrust/lefse-table/lefse.tbl.milkY.feed.csv")

#PMA untreated samples
picr.milkN <- subset_samples(picr.milk, PMA %in% "N")
saveRDS(picr.milkN,"picrust/picr.milkN.rds")
picr.milkN #249 taxa and 188 samples
# HTST milk 
picr.milkN.htst <- subset_samples(picr.milkN, SampleType %in% "HTST_milk")
lefse.tbl.milkN.htst <- phyloseq_to_lefs(picr.milkN.htst)
write.csv(lefse.tbl.milkN.htst, "picrust/lefse-table/lefse.tbl.milkN.htst.csv")
# HTST feed
picr.milkN.feed <- subset_samples(picr.milkN, SampleType %in% "HTST_feed")
lefse.tbl.milkN.feed <- phyloseq_to_lefs(picr.milkN.feed)
write.csv(lefse.tbl.milkN.feed, "picrust/lefse-table/lefse.tbl.milkN.feed.csv")

```

## Subset to contain cheese samples
```{r}
picr.cheese <- subset_samples(ps100.rare, SampleType %in% c("Cheese_0D","Cheese_30D","Cheese_90D","Cheese_120D"))
saveRDS(picr.cheese,"picrust/picr.cheese.rds")
picr.cheese

#PMA treated sample
picr.cheeseY <- subset_samples(picr.cheese, PMA %in% "Y")
saveRDS(picr.cheeseY,"picrust/picr.cheeseY.rds")
picr.cheeseY 
# All cheese 
picr.milkY.htst <- subset_samples(picr.milkY, SampleType %in% "HTST_milk")
lefse.tbl.milkY.htst <- phyloseq_to_lefs(picr.milkY.htst)
write.csv(lefse.tbl.milkY.htst, "picrust/lefse-table/lefse.tbl.milkY.htst.csv")
```

