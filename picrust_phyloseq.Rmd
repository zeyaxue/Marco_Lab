---
title: "picrust_phyloseq"
author: "Zeya Zhengyao Xue"
date: "October 5, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setting up 
```{r}
library(phyloseq);packageVersion("phyloseq")
library(biomformat);packageVersion("biomformat")
library(DESeq2); packageVersion("DESeq2")
library(ggplot2);packageVersion("ggplot2")
library(reshape2)
library(cowplot)
library(plyr)
library(dplyr)
library(RColorBrewer)

# Define project path
path <- "G:/My Drive/UC_Davis/Marco_lab/milk_microbiota/Hilmar_weekly_samples/QIIME2/"
# copy the .Rmd file to the path directory to generate html report
```

## Define function to use DESeq2 for differential analysis between cheese outcome
```{r}
# calculate geometric means prior to estimate size factors
gmMean = function(x, na.rm=TRUE){
  exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))
}

# Differential abundance and generate diagnostic plots and write sig tables
CheeseOutcomeDA <- function(ps, path.out) {
  psdds <- phyloseq_to_deseq2(ps, ~ CheeseOutcome)
  geoMeans <- apply(counts(psdds), 1, gm_mean)
  psdds <- estimateSizeFactors(psdds, geoMeans = geoMeans)
  dds <- DESeq(psdds, test = "Wald", fitType = "local") 
  plotDispEsts(dds, ylim = c(1e-6, 1e1)) #  need to inspect visually using local fit type
  res <- results(dds, cooksCutoff = FALSE)
  mcols(res, use.names=TRUE)
  plotMA(res)
  hist(res$pvalue, breaks=20, col="grey" )
  attr(res,"filterThreshold")
  plot(attr(res,"filterNumRej"),type="b",
     xlab="quantiles of 'baseMean'",
     ylab="number of rejections")
  alpha <- 0.01
  sigtab = res[which(res$padj < alpha), ]
  sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(ps)[rownames(sigtab), ], "matrix"))
  write.csv(sigtab, file.path(path.out))
}

# Independent filtering to remove weakly-expressed genes, which is impossible to 
# DA because the low read count suffer from high Poissson noise greater than 
# biological differences
# The goal is to improve the power of our test by reducing noise
## The DESeq2 software automatically performs independent filtering which 
## maximizes the number of genes with padj < 0.1

  
  # create bins using the quantile function
qs <- c( 0, quantile( res$baseMean[res$baseMean > 0], 0:7/7 ) )
# "cut" the genes into the bins
bins <- cut( res$baseMean, qs )
# rename the levels of the bins using the middle point
levels(bins) <- paste0("~",round(.5*qs[-1] + .5*qs[-length(qs)]))
# calculate the ratio of £p£ values less than .01 for each bin
ratios <- tapply( res$pvalue, bins, function(p) mean( p < .01, na.rm=TRUE ) )
# plot these ratios
barplot(ratios, xlab="mean normalized count", ylab="ratio of small $p$ values")
```


## Subset and DESeq2 analysis level analysis
The starting point is a picrust .biom file generated using Galaxy.
```{r}
# Read the sample information data frame  
samdf <- read.csv(file.path(path, "mapping/Run1-5_samdf-mc2.csv"))
rownames(samdf) <- samdf$SampleID
# Read the function table 
funtab = read_biom(file.path(path, "picrust/Predicted_Function.biom"))
# Get taxonomy  
taxtab = as.matrix(observation_metadata(funtab), rownames.force=TRUE) 
taxtab = tax_table(taxtab)
# Add taxonomy to FunTab
funtab = as(biom_data(funtab), "matrix")
funtab = otu_table(funtab, taxa_are_rows=TRUE)

# Merge as one phyloseq object 
ps <- phyloseq(otu_table(funtab,taxa_are_rows = FALSE),tax_table(taxtab), sample_data(samdf))
saveRDS(ps, file.path(path, "picrust/ps.rds"))
ps

# Following Bletz et al. 2016: Pathways with < 10 counts were removed from the table.
ps10 <- filter_taxa(ps, function(x) sum(x) > 10, TRUE)
saveRDS(ps10, file.path(path, "picrust/ps10.rds"))
ps10

# 1 # HTST milk samples 
ps.htst <- subset_samples(ps10, SampleType %in% "HTST_milk")
saveRDS(ps.htst, file.path(path, "picrust/ps.htst.rds"))
ps.htst
# PMA 
ps.htstY <- subset_samples(ps.htst, PMA %in% "Y")
saveRDS(ps.htstY, file.path(path, "picrust/ps.htstY.rds"))
ps.htstY
CheeseOutcomeDA(ps.htstY, path.out = file.path(path, "picrust/deseq_table/sigtab.htstY.csv"))


```


## Subset to contain milk samples
```{r}
#PMA treated sample
picr.milkY <- subset_samples(picr.milk, PMA %in% "Y")
saveRDS(picr.milkY,"picrust/picr.milkY.rds")
picr.milkY 
# HTST milk 
picr.milkY.htst <- subset_samples(picr.milkY, SampleType %in% "HTST_milk")
lefse.tbl.milkY.htst <- phyloseq_to_lefs(picr.milkY.htst)
write.csv(lefse.tbl.milkY.htst, "picrust/lefse-table/lefse.tbl.milkY.htst.csv")
# HTST feed
picr.milkY.feed <- subset_samples(picr.milkY, SampleType %in% "HTST_feed")
lefse.tbl.milkY.feed <- phyloseq_to_lefs(picr.milkY.feed)
write.csv(lefse.tbl.milkY.feed, "picrust/lefse-table/lefse.tbl.milkY.feed.csv")

#PMA untreated samples
picr.milkN <- subset_samples(picr.milk, PMA %in% "N")
saveRDS(picr.milkN,"picrust/picr.milkN.rds")
picr.milkN #249 taxa and 188 samples
# HTST milk 
picr.milkN.htst <- subset_samples(picr.milkN, SampleType %in% "HTST_milk")
lefse.tbl.milkN.htst <- phyloseq_to_lefs(picr.milkN.htst)
write.csv(lefse.tbl.milkN.htst, "picrust/lefse-table/lefse.tbl.milkN.htst.csv")
# HTST feed
picr.milkN.feed <- subset_samples(picr.milkN, SampleType %in% "HTST_feed")
lefse.tbl.milkN.feed <- phyloseq_to_lefs(picr.milkN.feed)
write.csv(lefse.tbl.milkN.feed, "picrust/lefse-table/lefse.tbl.milkN.feed.csv")

```

## Subset to contain cheese samples
```{r}
picr.cheese <- subset_samples(ps100.rare, SampleType %in% c("Cheese_0D","Cheese_30D","Cheese_90D","Cheese_120D"))
saveRDS(picr.cheese,"picrust/picr.cheese.rds")
picr.cheese

#PMA treated sample
picr.cheeseY <- subset_samples(picr.cheese, PMA %in% "Y")
saveRDS(picr.cheeseY,"picrust/picr.cheeseY.rds")
picr.cheeseY 
# All cheese 
picr.milkY.htst <- subset_samples(picr.milkY, SampleType %in% "HTST_milk")
lefse.tbl.milkY.htst <- phyloseq_to_lefs(picr.milkY.htst)
write.csv(lefse.tbl.milkY.htst, "picrust/lefse-table/lefse.tbl.milkY.htst.csv")
```

