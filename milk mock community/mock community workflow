#Zach Bendiks
#October 2018
#Mock milk community analysis (from Zeya)

#With Yetong's MERITS WP5 sequencing run, I included 6 additional samples to test lysis methods durinig DNA extraction. Two samples were vortexed for one minute (no bead beating), two were bead beated ONCE for 10 sec @ 4 m/s (short), and two were bead beated TWICE for 1 minute @ 6.5 m/s (long).

#chose to analyze as single-ended reads because paired end joining with this data gave weird results when Zeya did protocol optimization 

#Yetong's seq files 
#/home/marcolabuser/Yetong/MERITS-WP5_S1_L001_R1_001.fastq
#/home/marcolabuser/Yetong/MERITS-WP5_S1_L001_R2_001.fastq


#verifying mapping file 
validate_mapping_file.py -m /home/marcolabuser/Zach/mock_community/mock_mapfile.txt -o /home/marcolabuser/Zach/mock_community/mapfile_check


#extracting barcodes from both R1 and R2 files 
#treating the reads as single ended, I extracted barcodes separately from each file
#R1 files
extract_barcodes.py -f /home/marcolabuser/Yetong/MERITS-WP5_S1_L001_R1_001.fastq --bc1_len 8 -m /home/marcolabuser/Zach/mock_community/mock_mapfile.txt -o /home/marcolabuser/Zach/mock_community/R1/

gzip /home/marcolabuser/Zach/mock_community/R1/barcodes.fastq -r /home/marcolabuser/Zach/mock_community/R1/barcodes.fastq.gz

gzip /home/marcolabuser/Zach/mock_community/R1/reads.fastq -r /home/marcolabuser/Zach/mock_community/R1/reads.fastq.gz

mv /home/marcolabuser/Zach/mock_community/R1/reads.fastq.gz /home/marcolabuser/Zach/mock_community/R1/sequences.fastq.gz
#R2 files
extract_barcodes.py -f /home/marcolabuser/Yetong/MERITS-WP5_S1_L001_R2_001.fastq --bc1_len 8 -m /home/marcolabuser/Zach/mock_community/mock_mapfile.txt -o /home/marcolabuser/Zach/mock_community/R2/

gzip /home/marcolabuser/Zach/mock_community/R2/barcodes.fastq -r /home/marcolabuser/Zach/mock_community/R2/barcodes.fastq.gz

gzip /home/marcolabuser/Zach/mock_community/R2/reads.fastq -r /home/marcolabuser/Zach/mock_community/R2/reads.fastq.gz

mv /home/marcolabuser/Zach/mock_community/R2/reads.fastq.gz /home/marcolabuser/Zach/mock_community/R2/sequences.fastq.gz


#activate QIIME2 and importing data separately 
source activate qiime2-2018.4

qiime tools import --type EMPSingleEndSequences --input-path /home/marcolabuser/Zach/mock_community/R1/ --output-path /home/marcolabuser/Zach/mock_community/R1/R1_imported.qza

qiime tools import --type EMPSingleEndSequences --input-path /home/marcolabuser/Zach/mock_community/R2/ --output-path /home/marcolabuser/Zach/mock_community/R2/R2_imported.qza


#demultiplexing R1 and R2 sequences 
qiime demux emp-single \
  --i-seqs /home/marcolabuser/Zach/mock_community/R1/R1_imported.qza \
  --m-barcodes-file /home/marcolabuser/Zach/mock_community/mock_mapfile.txt \
  --m-barcodes-column BarcodeSequence \
  --o-per-sample-sequences /home/marcolabuser/Zach/mock_community/R1/demux.qza 

qiime demux summarize \
  --i-data /home/marcolabuser/Zach/mock_community/R1/demux.qza \
  --o-visualization /home/marcolabuser/Zach/mock_community/R1/demux.qzv
#position 265 is when quality drops off 
qiime demux emp-single \
  --i-seqs /home/marcolabuser/Zach/mock_community/R2/R2_imported.qza \
  --m-barcodes-file /home/marcolabuser/Zach/mock_community/mock_mapfile.txt \
  --m-barcodes-column BarcodeSequence \
  --o-per-sample-sequences /home/marcolabuser/Zach/mock_community/R2/demux.qza 

qiime demux summarize \
  --i-data /home/marcolabuser/Zach/mock_community/R2/demux.qza \
  --o-visualization /home/marcolabuser/Zach/mock_community/R2/demux.qzv
#position 217 is when quality drops off 


#DADA2 ASV picking on R1 and R2 
qiime dada2 denoise-single \
  --i-demultiplexed-seqs /home/marcolabuser/Zach/mock_community/R1/demux.qza \
  --p-trim-left 21 \
  --p-trunc-len 265 \
  --output-dir /home/marcolabuser/Zach/mock_community/R1/dada2/ \
  --p-n-threads 23

qiime feature-table summarize \
  --i-table /home/marcolabuser/Zach/mock_community/R1/dada2/table.qza \
  --o-visualization /home/marcolabuser/Zach/mock_community/R1/dada2/table.qzv \
  --m-sample-metadata-file /home/marcolabuser/Zach/mock_community/mock_mapfile.txt

qiime dada2 denoise-single \
  --i-demultiplexed-seqs /home/marcolabuser/Zach/mock_community/R2/demux.qza \
  --p-trim-left 21 \
  --p-trunc-len 217 \
  --output-dir /home/marcolabuser/Zach/mock_community/R2/dada2/ \
  --p-n-threads 23

qiime feature-table summarize \
  --i-table /home/marcolabuser/Zach/mock_community/R2/dada2/table.qza \
  --o-visualization /home/marcolabuser/Zach/mock_community/R2/dada2/table.qzv \
  --m-sample-metadata-file /home/marcolabuser/Zach/mock_community/mock_mapfile.txt


#merging feature tables and rep seqs from R1 and R2 
#have to supply the tables and rep seqs files individually
qiime feature-table merge \
  --i-tables /home/marcolabuser/Zach/mock_community/R1/dada2/table.qza \
  --i-tables /home/marcolabuser/Zach/mock_community/R2/dada2/table.qza \
  --p-overlap-method sum \
  --o-merged-table /home/marcolabuser/Zach/mock_community/merged_table.qza

qiime feature-table summarize \
  --i-table /home/marcolabuser/Zach/mock_community/merged_table.qza \
  --o-visualization /home/marcolabuser/Zach/mock_community/merged_table.qzv \
  --m-sample-metadata-file /home/marcolabuser/Zach/mock_community/mock_mapfile.txt

qiime feature-table merge-seqs \
  --i-data /home/marcolabuser/Zach/mock_community/R1/dada2/representative_sequences.qza \
  --i-data /home/marcolabuser/Zach/mock_community/R2/dada2/representative_sequences.qza \
  --o-merged-data /home/marcolabuser/Zach/mock_community/merged_rep_seqs.qza

qiime feature-table tabulate-seqs \
  --i-data /home/marcolabuser/Zach/mock_community/merged_rep_seqs.qza \
  --o-visualization /home/marcolabuser/Zach/mock_community/merged_rep_seqs.qzv


#generating phylogenetic tree
qiime alignment mafft \
  --i-sequences /home/marcolabuser/Zach/mock_community/merged_rep_seqs.qza \
  --o-alignment /home/marcolabuser/Zach/mock_community/aligned_merged_rep_seqs.qza

qiime alignment mask \
  --i-alignment /home/marcolabuser/Zach/mock_community/aligned_merged_rep_seqs.qza \
  --o-masked-alignment /home/marcolabuser/Zach/mock_community/masked_aligned_merged_rep_seqs.qza

qiime phylogeny fasttree \
  --i-alignment /home/marcolabuser/Zach/mock_community/masked_aligned_merged_rep_seqs.qza \
  --o-tree /home/marcolabuser/Zach/mock_community/tree_masked_aligned_merged_rep_seqs.qza

qiime phylogeny midpoint-root \
  --i-tree /home/marcolabuser/Zach/mock_community/tree_masked_aligned_merged_rep_seqs.qza \
  --o-rooted-tree /home/marcolabuser/Zach/mock_community/rooted_tree_masked_aligned_merged_rep_seqs.qza


#diversity + taxonomy analysis 
qiime diversity core-metrics-phylogenetic \
  --i-phylogeny /home/marcolabuser/Zach/mock_community/rooted_tree_masked_aligned_merged_rep_seqs.qza \
  --i-table /home/marcolabuser/Zach/mock_community/merged_table.qza \
  --p-sampling-depth 37877 \
  --m-metadata-file /home/marcolabuser/Zach/mock_community/mock_mapfile.txt \
  --output-dir /home/marcolabuser/Zach/mock_community/diversity

mkdir /home/marcolabuser/Zach/mock_community/diversity/taxonomy/

qiime feature-classifier classify-sklearn \
  --i-classifier /home/marcolabuser/QIIME2/gg-13-8-99-515-806-nb-classifier.qza \
  --i-reads /home/marcolabuser/Zach/mock_community/merged_rep_seqs.qza \
  --o-classification /home/marcolabuser/Zach/mock_community/diversity/taxonomy/taxonomy.qza

qiime taxa collapse \
  --i-table /home/marcolabuser/Zach/mock_community/diversity/rarefied_table.qza \
  --i-taxonomy /home/marcolabuser/Zach/mock_community/diversity/taxonomy/taxonomy.qza \
  --p-level 6 \
  --o-collapsed-table /home/marcolabuser/Zach/mock_community/diversity/taxonomy/collapsed_taxonomy.qza

#generating .txt file of the rarefied, collapsed ASV table
unzip /home/marcolabuser/Zach/mock_community/diversity/taxonomy/collapsed_taxonomy.qza -d /home/marcolabuser/Zach/mock_community/diversity/taxonomy/collapsed_taxonomy/

biom convert -i /home/marcolabuser/Zach/mock_community/diversity/taxonomy/collapsed_taxonomy/1b7ebece-f972-44ac-9ab2-bd877ff0df77/data/feature-table.biom -o /home/marcolabuser/Zach/mock_community/diversity/taxonomy/collapsed_taxonomy.txt --header-key taxonomy --to-tsv --table-type "OTU table"


